# Ralph Progress Log
Started: Initial setup
---

## Codebase Patterns
- Multi-tenant: every DB query must filter by tenantId
- Auth: NextAuth v5 with getServerSession, session includes tenantId
- Client-side auth: useSession hook from "next-auth/react" (SessionProvider in components/providers.tsx)
- tRPC routers in server/api/trpc/routers/, registered in _app.ts
- API routes (non-tRPC) in app/api/
- UI components: shadcn/ui from @/components/ui/
- Pages: app/(dashboard)/ for authenticated, app/(auth)/ for login/register, app/(marketing)/ for public pages
- Prisma client: import from @/lib/prisma (singleton pattern)
- Existing Subscription model in schema.prisma (line ~189)
- Registration flow: app/api/register/route.ts
- Navigation: components/navigation.tsx
- Middleware: middleware.ts (route protection)
---

## [2026-02-26 23:xx] - US-001
- Installed stripe and @stripe/stripe-js packages
- Created lib/stripe.ts with server-side Stripe client (singleton pattern, apiVersion: 2025-02-24.acacia)
- Created lib/stripe-client.ts with getStripe() helper for client-side loadStripe
- Env vars already configured in .env.local.example and .env.production.example
- Typecheck and build pass
- **Files changed:**
  - lib/stripe.ts (new)
  - lib/stripe-client.ts (new)
  - package.json (added dependencies)
  - package-lock.json
- **Learnings for future iterations:**
  - Stripe SDK requires specific apiVersion - always use latest from TypeScript types
  - Singleton pattern prevents multiple Stripe instances in dev hot reload
---

## [2026-02-26 23:32] - US-002
- Added PlanType enum (BASIC, PRO, ENTERPRISE) to Prisma schema
- Added SubscriptionStatus enum (TRIAL, ACTIVE, PAST_DUE, CANCELED, PAUSED)
- Updated Subscription model: plan (PlanType), status (SubscriptionStatus), trialEnd (DateTime?)
- Added plan field to Tenant model with default "TRIAL"
- Ran prisma migrate dev --name stripe-plans (SQLite dev.db created)
- Typecheck and build pass
- **Files changed:**
  - prisma/schema.prisma (modified)
  - prisma/migrations/20260226223205_stripe_plans/ (new, but not tracked per .gitignore)
- **Learnings for future iterations:**
  - Project intentionally ignores migration.sql files in .gitignore (only tracks schema)
  - Run migrations with: DATABASE_URL="file:./dev.db" npx prisma migrate dev --name <name>
  - Prisma enums are better than string types for type safety
---

## [2026-02-26 23:45] - US-003
- Updated register route to auto-create trial subscription
- Uses Prisma $transaction for atomic creation of tenant, user, and subscription
- Trial subscription: plan=PRO, status=TRIAL, trialEnd=now+14days
- Typecheck and build pass
- **Files changed:**
  - app/api/register/route.ts (modified)
- **Learnings for future iterations:**
  - Use Prisma $transaction when creating related entities to ensure atomicity
  - Trial users get PRO features (per PRD notes)
---

## [2026-02-26 23:55] - US-004
- Created marketing layout with header/footer navigation
- Created pricing page at app/(marketing)/pricing/page.tsx
- Shows 3 plan cards (Basic €57, Pro €147, Enterprise €347) with feature comparison
- Pro plan highlighted as "Most Popular" with Badge component
- CTA buttons: "Start Free Trial" (not logged in) / "Subscribe" (logged in)
- Includes ROI section and FAQs from docs/PLANS.md
- Uses useSession from next-auth/react for auth state
- Typecheck and build pass
- **Files changed:**
  - app/(marketing)/layout.tsx (new)
  - app/(marketing)/pricing/page.tsx (new)
- **Learnings for future iterations:**
  - SessionProvider is already set up in components/providers.tsx
  - Use useSession hook from "next-auth/react" for client-side auth state
  - shadcn Badge, Card, Button components work well for pricing cards
---

## [2026-02-26 24:xx] - US-005
- Created POST /api/stripe/checkout route with auth protection
- Uses auth() from lib/auth.ts to verify authenticated user
- Creates or retrieves Stripe Customer (linked to tenant.stripeCustomerId)
- Accepts { planId: 'basic'|'pro'|'enterprise' }
- Returns checkout session URL
- Fixed Stripe client to use lazy initialization (Proxy pattern) to avoid build-time errors
- Added Stripe Price IDs to .env.local.example and .env.production.example
- Typecheck and build pass
- **Files changed:**
  - app/api/stripe/checkout/route.ts (new)
  - lib/stripe.ts (modified - lazy init via Proxy)
  - .env.local.example (added STRIPE_PRICE_*)
  - .env.production.example (added STRIPE_PRICE_*)
- **Learnings for future iterations:**
  - Stripe SDK throws at import time if STRIPE_SECRET_KEY is empty during build
  - Use Proxy pattern for lazy initialization of third-party clients that require env vars
  - Auth protection via auth() from lib/auth.ts, check session?.user?.tenantId
---

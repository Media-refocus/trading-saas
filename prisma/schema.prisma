generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Plan types for subscriptions
enum PlanType {
  BASIC
  PRO
  ENTERPRISE
}

// Subscription status
enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

// Multi-tenancy: Cada cliente tiene su tenant
model Tenant {
  id               String              @id @default(cuid())
  name             String
  email            String              @unique
  stripeCustomerId String?             @unique
  plan             String              @default("TRIAL") // TRIAL, BASIC, PRO, ENTERPRISE
  telegramChatId   String?             @unique
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  users            User[]
  tradingAccounts  TradingAccount[]
  signals          Signal[]
  positions        Position[]
  subscriptions    Subscription[]
  backtests        Backtest[]
  simulatedTrades  SimulatedTrade[]
  strategies       Strategy[]

  // Bot Operativa
  botConfigs       BotConfig[]
  trades           Trade[]

  // Marketplace
  publishedStrategies PublishedStrategy[]
}

model User {
  id                  String              @id @default(cuid())
  tenantId            String
  email               String              @unique
  name                String?
  emailVerified       DateTime?
  image               String?
  password            String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  accounts            Account[]
  notifications       Notification[]
  publishedStrategies PublishedStrategy[]
  sessions            Session[]
  strategyComments    StrategyComment[]
  strategyLikes       StrategyLike[]
  tradingAccounts     TradingAccount[]
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model TradingAccount {
  id                 String     @id @default(cuid())
  tenantId           String
  userId             String?
  broker             String
  accountNumber      String
  platform           String
  server             String?
  encryptedApiKey    String
  encryptedApiSecret String?
  isActive           Boolean    @default(true)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  positions          Position[]
  user               User?      @relation(fields: [userId], references: [id])
  tenant             Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Signal {
  id              String     @id @default(cuid())
  tenantId        String
  botConfigId     String?
  side            String
  price           Float?
  symbol          String
  messageText     String
  receivedAt      DateTime   @default(now())
  channelId       String?
  channelName     String?
  messageId       String?
  status          String     @default("PENDING")
  processedAt     DateTime?
  isCloseSignal   Boolean    @default(false)
  restrictionType String?
  maxLevels       Int        @default(4)
  errorMessage    String?
  createdAt       DateTime   @default(now())
  positions       Position[]
  botConfig       BotConfig? @relation(fields: [botConfigId], references: [id])
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  trades          Trade[]

  @@index([tenantId, receivedAt])
  @@index([botConfigId, status])
}

model Position {
  id               String          @id @default(cuid())
  tenantId         String
  signalId         String?
  tradingAccountId String?
  side             String
  symbol           String
  lotSize          Float
  openPrice        Float
  closePrice       Float?
  stopLoss         Float?
  takeProfit       Float?
  status           String          @default("OPEN")
  openedAt         DateTime        @default(now())
  closedAt         DateTime?
  profitPips       Float?
  profitMoney      Float?
  level            Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  tradingAccount   TradingAccount? @relation(fields: [tradingAccountId], references: [id])
  signal           Signal?         @relation(fields: [signalId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                 String             @id @default(cuid())
  tenantId           String
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  plan               PlanType           // BASIC, PRO, ENTERPRISE
  stripePriceId      String?
  stripeSubId        String?            @unique
<<<<<<< HEAD
  status             SubscriptionStatus @default(TRIAL) // TRIAL, ACTIVE, PAST_DUE, CANCELED, PAUSED
  trialEnd           DateTime?          // When trial ends

=======
  status             SubscriptionStatus @default(TRIAL)
  trialEnd           DateTime?
>>>>>>> 953a5c5 (feat: implementar notificaciones Telegram (Fase 7))
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model Backtest {
  id              String           @id @default(cuid())
  tenantId        String
  name            String?
  strategyName    String
  status          String           @default("PENDING")
  parameters      Json
  totalTrades     Int              @default(0)
  totalProfit     Float            @default(0)
  totalProfitPips Float            @default(0)
  winRate         Float            @default(0)
  maxDrawdown     Float            @default(0)
  profitFactor    Float            @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?
  ticksProcessed  Int              @default(0)
  totalTicks      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  trades          SimulatedTrade[]
}

model SimulatedTrade {
  id          String   @id @default(cuid())
  tenantId    String
  backtestId  String
  signalIndex Int
  type        String
  side        String
  price       Float
  lotSize     Float
  level       Int      @default(0)
  profit      Float
  profitPips  Float
  timestamp   DateTime
  createdAt   DateTime @default(now())
  backtest    Backtest @relation(fields: [backtestId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TickData {
  id        Int      @id @default(autoincrement())
  symbol    String
  timestamp DateTime
  bid       Float
  ask       Float
  spread    Float

  @@index([symbol, timestamp])
  @@index([timestamp])
  @@index([timestamp], map: "idx_tick_data_timestamp")
}

model Strategy {
  id                String    @id @default(cuid())
  tenantId          String
  name              String
  description       String?
  strategyName      String    @default("Custom")
  lotajeBase        Float     @default(0.1)
  numOrders         Int       @default(1)
  pipsDistance      Int       @default(10)
  maxLevels         Int       @default(4)
  takeProfitPips    Int       @default(20)
  stopLossPips      Int?
  useStopLoss       Boolean   @default(false)
  useTrailingSL     Boolean   @default(true)
  trailingSLPercent Int       @default(50)
  restrictionType   String?
  lastTotalTrades   Int?
  lastTotalProfit   Float?
  lastWinRate       Float?
  lastMaxDrawdown   Float?
  lastTestedAt      DateTime?
  isFavorite        Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model PublishedStrategy {
  id                String              @id @default(cuid())
  tenantId          String
  authorId          String
  parentStrategyId  String?
  name              String
  description       String?
  version           Int                 @default(1)
  strategyName      String              @default("Custom")
  lotajeBase        Float               @default(0.1)
  numOrders         Int                 @default(1)
  pipsDistance      Int                 @default(10)
  maxLevels         Int                 @default(4)
  takeProfitPips    Int                 @default(20)
  stopLossPips      Int?
  useStopLoss       Boolean             @default(false)
  useTrailingSL     Boolean             @default(true)
  trailingSLPercent Int                 @default(50)
  restrictionType   String?
  totalTrades       Int                 @default(0)
  totalProfit       Float               @default(0)
  winRate           Float               @default(0)
  maxDrawdown       Float               @default(0)
  profitFactor      Float               @default(0)
  likesCount        Int                 @default(0)
  forksCount        Int                 @default(0)
  downloadsCount    Int                 @default(0)
  tags              Json?
  isPublic          Boolean             @default(true)
  publishedAt       DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  parentStrategy    PublishedStrategy?  @relation("StrategyForks", fields: [parentStrategyId], references: [id])
  forks             PublishedStrategy[] @relation("StrategyForks")
  author            User                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  comments          StrategyComment[]
  likes             StrategyLike[]

  @@index([tenantId])
  @@index([authorId])
  @@index([parentStrategyId])
  @@index([isPublic])
}

model BotConfig {
  id                    String         @id @default(cuid())
  tenantId              String         @unique
  apiKeyHash            String
  status                String         @default("OFFLINE")
  telegramApiIdEnc      String?
  telegramApiHashEnc    String?
  telegramSessionEnc    String?
  telegramChannels      Json?
  symbol                String         @default("XAUUSD")
  magicNumber           Int            @default(20250101)
  entryLot              Float          @default(0.1)
  entryNumOrders        Int            @default(1)
  entryTrailingActivate Int?
  entryTrailingStep     Int?
  entryTrailingBack     Int?
  entryTrailingBuffer   Int?
  gridStepPips          Int            @default(10)
  gridLot               Float          @default(0.1)
  gridMaxLevels         Int            @default(4)
  gridNumOrders         Int            @default(1)
  gridTolerancePips     Int            @default(1)
  restrictionType       String?
  maxLevels             Int            @default(4)
  dailyLossLimitPercent Float?
  dailyLossCurrent      Float          @default(0)
  dailyLossResetAt      DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  botAccounts           BotAccount[]
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  heartbeats            BotHeartbeat[]
  signals               Signal[]
  trades                Trade[]

  @@index([tenantId])
  @@index([apiKeyHash])
}

model BotAccount {
  id          String        @id @default(cuid())
  botConfigId String
  loginEnc    String
  passwordEnc String
  serverEnc   String
  pathEnc     String?
  symbol      String        @default("XAUUSD")
  magic       Int
  isActive    Boolean       @default(true)
  lastSyncAt  DateTime?
  lastBalance Float?
  lastEquity  Float?
  lastMargin  Float?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  botConfig   BotConfig     @relation(fields: [botConfigId], references: [id], onDelete: Cascade)
  positions   BotPosition[]
  trades      Trade[]

  @@index([botConfigId])
}

model BotHeartbeat {
  id                String    @id @default(cuid())
  botConfigId       String
  timestamp         DateTime  @default(now())
  version           String?
  uptimeSeconds     Int?
  mt5Connected      Boolean   @default(false)
  telegramConnected Boolean   @default(false)
  openPositions     Int       @default(0)
  pendingOrders     Int       @default(0)
  memoryMB          Float?
  cpuPercent        Float?
  errorMessage      String?
  botConfig         BotConfig @relation(fields: [botConfigId], references: [id], onDelete: Cascade)

  @@index([botConfigId, timestamp])
}

model Trade {
  id           String      @id @default(cuid())
  tenantId     String
  botConfigId  String?
  botAccountId String?
  signalId     String?
  side         String
  symbol       String
  level        Int         @default(0)
  mt5Ticket    Int?
  openPrice    Float
  lotSize      Float
  openedAt     DateTime    @default(now())
  closePrice   Float?
  closedAt     DateTime?
  closeReason  String?
  stopLoss     Float?
  takeProfit   Float?
  virtualSL    Float?
  profitPips   Float?
  profitMoney  Float?
  commission   Float?
  swap         Float?
  status       String      @default("OPEN")
  errorMessage String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  signal       Signal?     @relation(fields: [signalId], references: [id])
  botAccount   BotAccount? @relation(fields: [botAccountId], references: [id])
  botConfig    BotConfig?  @relation(fields: [botConfigId], references: [id])
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, openedAt])
  @@index([botConfigId, status])
  @@index([signalId])
}

model BotPosition {
  id             String     @id @default(cuid())
  botAccountId   String
  tradeId        String?    @unique
  mt5Ticket      Int
  symbol         String
  side           String
  level          Int        @default(0)
  openPrice      Float
  currentPrice   Float?
  lotSize        Float
  stopLoss       Float?
  takeProfit     Float?
  virtualSL      Float?
  unrealizedPL   Float?
  unrealizedPips Float?
  openedAt       DateTime
  lastSyncAt     DateTime   @default(now())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  botAccount     BotAccount @relation(fields: [botAccountId], references: [id], onDelete: Cascade)

  @@unique([botAccountId, mt5Ticket])
  @@index([botAccountId])
}

model StrategyLike {
  id                  String            @id @default(cuid())
  userId              String
  publishedStrategyId String
  createdAt           DateTime          @default(now())
  publishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, publishedStrategyId])
  @@index([publishedStrategyId])
}

model StrategyComment {
  id                  String            @id @default(cuid())
  userId              String
  publishedStrategyId String
  content             String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  publishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([publishedStrategyId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Backtest {
  id              String           @id
  tenantId        String
  name            String?
  strategyName    String
  status          String           @default("PENDING")
  parameters      Json
  totalTrades     Int              @default(0)
  totalProfit     Float            @default(0)
  totalProfitPips Float            @default(0)
  winRate         Float            @default(0)
  maxDrawdown     Float            @default(0)
  profitFactor    Float            @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?
  ticksProcessed  Int              @default(0)
  totalTicks      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  Tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  SimulatedTrade  SimulatedTrade[]
}

model BotAccount {
  id          String        @id
  botConfigId String
  loginEnc    String
  passwordEnc String
  serverEnc   String
  pathEnc     String?
  symbol      String        @default("XAUUSD")
  magic       Int
  isActive    Boolean       @default(true)
  lastSyncAt  DateTime?
  lastBalance Float?
  lastEquity  Float?
  lastMargin  Float?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  BotConfig   BotConfig     @relation(fields: [botConfigId], references: [id], onDelete: Cascade)
  BotPosition BotPosition[]
  Trade       Trade[]

  @@index([botConfigId])
}

model BotConfig {
  id                    String         @id
  tenantId              String         @unique
  apiKeyHash            String
  status                String         @default("OFFLINE")
  telegramApiIdEnc      String?
  telegramApiHashEnc    String?
  telegramSessionEnc    String?
  telegramChannels      Json?
  symbol                String         @default("XAUUSD")
  magicNumber           Int            @default(20250101)
  entryLot              Float          @default(0.1)
  entryNumOrders        Int            @default(1)
  entryTrailingActivate Int?
  entryTrailingStep     Int?
  entryTrailingBack     Int?
  entryTrailingBuffer   Int?
  gridStepPips          Int            @default(10)
  gridLot               Float          @default(0.1)
  gridMaxLevels         Int            @default(4)
  gridNumOrders         Int            @default(1)
  gridTolerancePips     Int            @default(1)
  restrictionType       String?
  maxLevels             Int            @default(4)
  dailyLossLimitPercent Float?
  dailyLossCurrent      Float          @default(0)
  dailyLossResetAt      DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime
  BotAccount            BotAccount[]
  Tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  BotHeartbeat          BotHeartbeat[]
  Signal                Signal[]
  Trade                 Trade[]

  @@index([apiKeyHash])
  @@index([tenantId])
}

model BotHeartbeat {
  id                String    @id
  botConfigId       String
  timestamp         DateTime  @default(now())
  version           String?
  uptimeSeconds     Int?
  mt5Connected      Boolean   @default(false)
  telegramConnected Boolean   @default(false)
  openPositions     Int       @default(0)
  pendingOrders     Int       @default(0)
  memoryMB          Float?
  cpuPercent        Float?
  errorMessage      String?
  BotConfig         BotConfig @relation(fields: [botConfigId], references: [id], onDelete: Cascade)

  @@index([botConfigId, timestamp])
}

model BotPosition {
  id             String     @id
  botAccountId   String
  tradeId        String?    @unique
  mt5Ticket      Int
  symbol         String
  side           String
  level          Int        @default(0)
  openPrice      Float
  currentPrice   Float?
  lotSize        Float
  stopLoss       Float?
  takeProfit     Float?
  virtualSL      Float?
  unrealizedPL   Float?
  unrealizedPips Float?
  openedAt       DateTime
  lastSyncAt     DateTime   @default(now())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  BotAccount     BotAccount @relation(fields: [botAccountId], references: [id], onDelete: Cascade)

  @@unique([botAccountId, mt5Ticket])
  @@index([botAccountId])
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model Position {
  id               String          @id
  tenantId         String
  signalId         String?
  tradingAccountId String?
  side             String
  symbol           String
  lotSize          Float
  openPrice        Float
  closePrice       Float?
  stopLoss         Float?
  takeProfit       Float?
  status           String          @default("OPEN")
  openedAt         DateTime        @default(now())
  closedAt         DateTime?
  profitPips       Float?
  profitMoney      Float?
  level            Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  TradingAccount   TradingAccount? @relation(fields: [tradingAccountId], references: [id])
  Signal           Signal?         @relation(fields: [signalId], references: [id])
  Tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model PublishedStrategy {
  id                      String              @id
  tenantId                String
  authorId                String
  parentStrategyId        String?
  name                    String
  description             String?
  version                 Int                 @default(1)
  strategyName            String              @default("Custom")
  lotajeBase              Float               @default(0.1)
  numOrders               Int                 @default(1)
  pipsDistance            Int                 @default(10)
  maxLevels               Int                 @default(4)
  takeProfitPips          Int                 @default(20)
  stopLossPips            Int?
  useStopLoss             Boolean             @default(false)
  useTrailingSL           Boolean             @default(true)
  trailingSLPercent       Int                 @default(50)
  restrictionType         String?
  totalTrades             Int                 @default(0)
  totalProfit             Float               @default(0)
  winRate                 Float               @default(0)
  maxDrawdown             Float               @default(0)
  profitFactor            Float               @default(0)
  likesCount              Int                 @default(0)
  forksCount              Int                 @default(0)
  downloadsCount          Int                 @default(0)
  tags                    Json?
  isPublic                Boolean             @default(true)
  publishedAt             DateTime            @default(now())
  createdAt               DateTime            @default(now())
  updatedAt               DateTime
  PublishedStrategy       PublishedStrategy?  @relation("PublishedStrategyToPublishedStrategy", fields: [parentStrategyId], references: [id])
  other_PublishedStrategy PublishedStrategy[] @relation("PublishedStrategyToPublishedStrategy")
  User                    User                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  Tenant                  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  StrategyComment         StrategyComment[]
  StrategyLike            StrategyLike[]

  @@index([isPublic])
  @@index([parentStrategyId])
  @@index([authorId])
  @@index([tenantId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Signal {
  id              String     @id
  tenantId        String
  botConfigId     String?
  side            String
  price           Float?
  symbol          String
  messageText     String
  receivedAt      DateTime   @default(now())
  channelId       String?
  channelName     String?
  messageId       String?
  status          String     @default("PENDING")
  processedAt     DateTime?
  isCloseSignal   Boolean    @default(false)
  restrictionType String?
  maxLevels       Int        @default(4)
  errorMessage    String?
  createdAt       DateTime   @default(now())
  Position        Position[]
  BotConfig       BotConfig? @relation(fields: [botConfigId], references: [id])
  Tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  Trade           Trade[]

  @@index([botConfigId, status])
  @@index([tenantId, receivedAt])
}

model SimulatedTrade {
  id          String   @id
  tenantId    String
  backtestId  String
  signalIndex Int
  type        String
  side        String
  price       Float
  lotSize     Float
  level       Int      @default(0)
  profit      Float
  profitPips  Float
  timestamp   DateTime
  createdAt   DateTime @default(now())
  Backtest    Backtest @relation(fields: [backtestId], references: [id], onDelete: Cascade)
  Tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Strategy {
  id                String    @id
  tenantId          String
  name              String
  description       String?
  strategyName      String    @default("Custom")
  lotajeBase        Float     @default(0.1)
  numOrders         Int       @default(1)
  pipsDistance      Int       @default(10)
  maxLevels         Int       @default(4)
  takeProfitPips    Int       @default(20)
  stopLossPips      Int?
  useStopLoss       Boolean   @default(false)
  useTrailingSL     Boolean   @default(true)
  trailingSLPercent Int       @default(50)
  restrictionType   String?
  lastTotalTrades   Int?
  lastTotalProfit   Float?
  lastWinRate       Float?
  lastMaxDrawdown   Float?
  lastTestedAt      DateTime?
  isFavorite        Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  Tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model StrategyComment {
  id                  String            @id
  userId              String
  publishedStrategyId String
  content             String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  PublishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)
  User                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([publishedStrategyId])
}

model StrategyLike {
  id                  String            @id
  userId              String
  publishedStrategyId String
  createdAt           DateTime          @default(now())
  PublishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)
  User                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, publishedStrategyId])
  @@index([publishedStrategyId])
}

model Subscription {
  id                 String    @id
  tenantId           String
  plan               String
  stripePriceId      String?
  stripeSubId        String?   @unique
  status             String    @default("TRIAL")
  trialEnd           DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  Tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Tenant {
  id                String              @id
  name              String
  email             String              @unique
  stripeCustomerId  String?             @unique
  plan              String              @default("TRIAL")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  telegramChatId    String?             @unique
  Backtest          Backtest[]
  BotConfig         BotConfig?
  Position          Position[]
  PublishedStrategy PublishedStrategy[]
  Signal            Signal[]
  SimulatedTrade    SimulatedTrade[]
  Strategy          Strategy[]
  Subscription      Subscription[]
  Trade             Trade[]
  TradingAccount    TradingAccount[]
  User              User[]
}

model TickData {
  id        Int      @id @default(autoincrement())
  symbol    String
  timestamp DateTime
  bid       Float
  ask       Float
  spread    Float

  @@index([timestamp])
  @@index([symbol, timestamp])
}

model Trade {
  id           String      @id
  tenantId     String
  botConfigId  String?
  botAccountId String?
  signalId     String?
  side         String
  symbol       String
  level        Int         @default(0)
  mt5Ticket    Int?
  openPrice    Float
  lotSize      Float
  openedAt     DateTime    @default(now())
  closePrice   Float?
  closedAt     DateTime?
  closeReason  String?
  stopLoss     Float?
  takeProfit   Float?
  virtualSL    Float?
  profitPips   Float?
  profitMoney  Float?
  commission   Float?
  swap         Float?
  status       String      @default("OPEN")
  errorMessage String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  Signal       Signal?     @relation(fields: [signalId], references: [id])
  BotAccount   BotAccount? @relation(fields: [botAccountId], references: [id])
  BotConfig    BotConfig?  @relation(fields: [botConfigId], references: [id])
  Tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([signalId])
  @@index([botConfigId, status])
  @@index([tenantId, openedAt])
}

model TradingAccount {
  id                 String     @id
  tenantId           String
  userId             String?
  broker             String
  accountNumber      String
  platform           String
  server             String?
  encryptedApiKey    String
  encryptedApiSecret String?
  isActive           Boolean    @default(true)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime
  Position           Position[]
  User               User?      @relation(fields: [userId], references: [id])
  Tenant             Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model User {
  id                String              @id
  tenantId          String
  email             String              @unique
  name              String?
  emailVerified     DateTime?
  image             String?
  password          String?
  role              String              @default("USER")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  Account           Account[]
  Notification      Notification[]
  PublishedStrategy PublishedStrategy[]
  Session           Session[]
  StrategyComment   StrategyComment[]
  StrategyLike      StrategyLike[]
  TradingAccount    TradingAccount[]
  Tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
